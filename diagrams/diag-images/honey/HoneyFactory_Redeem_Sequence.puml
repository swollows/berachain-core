@startuml HoneyFactory_Redeem_Sequence

actor User
participant Factory as "HoneyFactory"
participant HoneyToken as "Honey"
participant Collateral as "ERC20 (Collateral)"
participant Vault as "CollateralVault"
participant PriceOracle as "IPriceOracle"

User -> Factory : redeem(asset, honeyAmount, receiver, expectBasketMode)
activate Factory

Factory -> Factory : isBasketModeEnabled(false)
activate Factory
Factory --> Factory : basketMode
deactivate Factory

' 기대하는 바스켓 모드와 현재 모드가 일치하는지 확인
alt expectBasketMode != basketMode
    Factory --> User : revert UnexpectedBasketModeStatus
end

Factory -> HoneyToken : burn(User, totalHoneyToBurn)
activate HoneyToken
HoneyToken -> HoneyToken : _burn(User, totalHoneyToBurn)
HoneyToken --> Factory
deactivate HoneyToken

Factory -> Factory : _redeem(asset, honeyAmount, receiver, basketMode)
activate Factory

Factory -> Factory : _getWeights(false, basketMode)
activate Factory
Factory --> Factory : weights
deactivate Factory

Factory -> Factory : _checkCollateralLimits(collaterals, redeemAmounts)

loop collaterals (or single asset if not basketMode)
    Factory -> Factory : Calculate sharesToRedeem based on honeyToRedeem and redeemRate
    Factory -> Vault : previewRedeem(sharesToRedeem)
    activate Vault
    Vault --> Factory : collateralAmount
    deactivate Vault

    Factory -> Factory : _collectFee(collateral, feeShares)
    activate Factory
    Factory -> Factory : Update collectedFees[feeReceiver][collateral]
    Factory -> Factory : Update collectedFees[polFeeCollector][collateral]
    Factory -> Factory : Update collectedAssetFees[collateral]
    Factory --> Factory
    deactivate Factory

    Factory -> Vault : redeem(sharesToRedeem, receiver, Factory)
    activate Vault
    Vault -> Vault : _burn(Factory, sharesToRedeem)
    Vault -> Collateral : safeTransfer(receiver, collateralAmount)
    activate Collateral
    Collateral --> Vault
    deactivate Collateral
    Vault --> Factory : collateralAmount
    deactivate Vault
end

Factory --> Factory : totalCollateralAmounts
deactivate Factory

Factory --> User : totalCollateralAmounts
deactivate Factory

@enduml 